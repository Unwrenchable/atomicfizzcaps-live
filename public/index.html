<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>ATOMIC FIZZ • VAULT 77 • WASTELAND GPS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html, body {
            height: 100%;
            background: #000;
            font-family: VT323,monospace;
            color: #00ff41
        }

        body {
            background: radial-gradient(circle at center,#002200,#000)
        }

        .pipboy {
            position: fixed;
            inset: 0;
            padding: 12px;
            background: #001100;
            box-shadow: 0 0 160px #00ff41
        }

        .panel {
            position: absolute;
            inset: 12px;
            background: #000;
            border-radius: 14px;
            padding: 14px;
            overflow: hidden;
            box-shadow: inset 0 0 80px #003300,0 0 80px rgba(0,255,65,0.18)
        }

        h1 {
            font-size: 2.6rem;
            letter-spacing: 8px;
            background: linear-gradient(90deg,#00ff41,#66ff99);
            -webkit-background-clip: text;
            color: transparent;
            margin-bottom: 6px
        }

        .sub {
            opacity: 0.6;
            letter-spacing: 6px;
            margin-bottom: 12px
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            gap: 12px
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .btn, .wallet-btn {
            background: #001100;
            color: #00ff41;
            border: 2px solid #00ff41;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold
        }

        .wallet-btn {
            background: #002200
        }

        #status {
            color: #ff66aa;
            font-size: 0.95rem;
            min-width: 220px;
            text-align: right
        }

        .statbar {
            display: grid;
            grid-template-columns: repeat(4,1fr);
            gap: 12px;
            margin: 12px 0
        }

        .stat {
            background: #000;
            border-radius: 8px;
            padding: 10px;
            border: 2px solid rgba(0,255,65,0.06);
            text-align: center
        }

        .val {
            font-size: 1.6rem;
            color: #ffff66
        }

        #mapWrap {
            height: 56vh;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(0,255,65,0.06);
            box-shadow: inset 0 0 60px rgba(0,255,65,0.04);
            position: relative
        }

        #map {
            width: 100%;
            height: 100%
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-top: 12px
        }

        .tab {
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(0,255,65,0.06);
            cursor: pointer
        }

            .tab.active {
                background: #002200;
                border-color: #00ff41
            }

        .drawer {
            position: absolute;
            right: 18px;
            top: 86px;
            width: 360px;
            max-height: 56%;
            background: rgba(0,17,0,0.96);
            border: 2px solid #00ff41;
            border-radius: 10px;
            padding: 12px;
            overflow: auto;
            z-index: 1400;
            display: none
        }

            .drawer.open {
                display: block
            }

        .list-item {
            padding: 8px 10px;
            border-bottom: 1px dashed rgba(0,255,65,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .muted {
            opacity: 0.7
        }

        .muted-small {
            font-size: 0.85rem;
            opacity: 0.8
        }

        .gps-badge {
            position: absolute;
            left: 18px;
            bottom: 18px;
            background: rgba(0,0,0,0.8);
            border: 2px solid #00ff41;
            padding: 8px 12px;
            border-radius: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
            z-index: 1200
        }

        .acc-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6666;
            box-shadow: 0 0 8px rgba(255,102,102,0.2)
        }

        .acc-green {
            background: #66ff99;
            box-shadow: 0 0 8px rgba(102,255,153,0.12)
        }

        .acc-amber {
            background: #ffcc66;
            box-shadow: 0 0 8px rgba(255,204,102,0.12)
        }

        .mint-modal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%,-50%);
            background: #001100;
            border: 2px solid #00ff41;
            padding: 12px;
            border-radius: 10px;
            z-index: 2000;
            display: none
        }

            .mint-modal.open {
                display: block
            }

        @media (max-width:900px) {
            .drawer {
                width: 300px
            }
        }

        @media (max-width:640px) {
            .drawer {
                width: 260px;
                top: 72px
            }

            .statbar {
                grid-template-columns: repeat(2,1fr)
            }
        }
    </style>
</head>
<body>
    <div class="pipboy">
        <div class="panel">
            <div class="header-row">
                <div><h1>ATOMIC FIZZ</h1><div class="sub">VAULT 77 • WASTELAND GPS</div></div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
                    <div class="controls">
                        <button class="btn" id="centerBtn">Center on Player</button>
                        <button class="btn" id="recenterMojave">Recenter Mojave</button>
                        <button class="wallet-btn" id="connectPhantom">Connect Phantom</button>
                    </div>
                    <div id="status">Status: ready</div>
                </div>
            </div>
            <div class="statbar">
                <div class="stat"><div class="val" id="lvl">1</div><div class="muted-small">LEVEL</div></div>
                <div class="stat"><div class="val" id="hp">100/100</div><div class="muted-small">HP</div></div>
                <div class="stat"><div class="val" id="caps">0</div><div class="muted-small">CAPS</div></div>
                <div class="stat"><div class="val" id="claimed">0</div><div class="muted-small">CLAIMED</div></div>
            </div>
            <div id="mapWrap">
                <div id="map"></div>
                <div class="gps-badge" id="gpsBadge"><div id="accDot" class="acc-dot"></div><div id="accText">GPS: —</div></div>
            </div>
            <div class="tabs">
                <div class="tab active" data-panel="map">MAP</div>
                <div class="tab" data-panel="stat">STAT</div>
                <div class="tab" data-panel="items">ITEMS</div>
                <div class="tab" data-panel="quests">QUESTS</div>
            </div>
            <div class="drawer" id="sidePanel">
                <button class="btn" id="panelClose" style="float:right">X</button>
                <h4 id="panelTitle">Panel</h4>
                <div id="panelBody"></div>
            </div>
            <div id="mintModal" class="mint-modal">
                <div id="mintTitle">Minting NFT</div>
                <div id="mintMsg" class="muted-small">Preparing...</div>
                <div id="mintProgress" style="height:8px;background:#002200;border-radius:6px;overflow:hidden;margin-top:8px">
                    <i style="display:block;height:100%;background:linear-gradient(90deg,#00ff41,#66ff99);width:0%"></i>
                </div>
                <div style="margin-top:10px;text-align:right"><button class="btn" id="mintCloseBtn">Close</button></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/bs58@6.0.0/dist/index.min.js"></script>
    <script>
        /* ATOMIC FIZZ — 100% FINAL WORKING VERSION — DEC 2025 */
        const API_BASE = window.location.origin;
        let map, playerMarker = null, wallet = null;
        let player = { lvl: 1, hp: 100, maxHp: 100, caps: 0, gear: [], claimed: new Set() };
        let markers = {}, lastAccuracy = 999, playerLatLng = null;

        const MAX_ACCEPTABLE_ACCURACY = 20, AMBER_THRESHOLD = 40, SMOOTHING_WINDOW = 8;
        const MIN_UPDATE_DISTANCE = 1.5, CLAIM_RADIUS_METERS = 50;

        class SimpleKalman {
            constructor(q = 1e-7, r = 1e-5) { this.q = q; this.r = r; this.x = null; this.p = 1; }
            update(m) { if (this.x === null) return this.x = m; this.p += this.q; const k = this.p / (this.p + this.r); this.x += k * (m - this.x); this.p = (1 - k) * this.p; return this.x; }
        }
        const kfLat = new SimpleKalman(), kfLng = new SimpleKalman();
        let gpsSamples = [];

        function pushGpsSample(lat, lng, accuracy) {
            gpsSamples.push({ lat, lng, accuracy: accuracy || 999, ts: Date.now() });
            if (gpsSamples.length > 60) gpsSamples = gpsSamples.slice(-60);
            ensurePlayerMarkerFromSamples();
            updateAccuracyBadge(accuracy || 999);
        }

        function weightedCentroid(samples) {
            if (!samples?.length) return null;
            let sumLat = 0, sumLng = 0, sumW = 0, eps = 0.0001;
            samples.forEach(s => { const w = 1 / ((s.accuracy || 999) + eps); sumLat += s.lat * w; sumLng += s.lng * w; sumW += w; });
            return { lat: sumLat / sumW, lng: sumLng / sumW };
        }

        function updateAccuracyBadge(acc) {
            lastAccuracy = acc || 999;
            const dot = document.getElementById('accDot'), text = document.getElementById('accText');
            text.textContent = `GPS: ${Math.round(lastAccuracy)}m`;
            dot.className = lastAccuracy <= MAX_ACCEPTABLE_ACCURACY ? 'acc-dot acc-green' :
                lastAccuracy <= AMBER_THRESHOLD ? 'acc-dot acc-amber' : 'acc-dot';
        }

        function ensurePlayerMarkerFromSamples() {
            if (!gpsSamples.length) return;
            const recent = gpsSamples.slice(-SMOOTHING_WINDOW);
            const c = weightedCentroid(recent); if (!c) return;
            const lat = kfLat.update(c.lat), lng = kfLng.update(c.lng);
            const ll = L.latLng(lat, lng);
            if (!playerLatLng || map.distance(playerLatLng, ll) > MIN_UPDATE_DISTANCE) {
                playerLatLng = ll;
                if (!playerMarker) playerMarker = L.circleMarker([lat, lng], { radius: 8, color: '#00ff41', weight: 3, fillColor: '#00ff41', fillOpacity: 1 }).addTo(map).bindPopup('You');
                else playerMarker.setLatLng(ll);
                saveState();
            }
        }

        function saveState() {
            try {
                localStorage.setItem('af_state', JSON.stringify({
                    player: { lvl: player.lvl, hp: player.hp, maxHp: player.maxHp, caps: player.caps },
                    claimed: Array.from(player.claimed),
                    playerLatLng: playerLatLng ? [playerLatLng.lat, playerLatLng.lng] : null
                }));
            } catch (e) { }
        }
        function loadState() {
            try {
                const s = JSON.parse(localStorage.getItem('af_state') || 'null'); if (s) {
                    if (s.player) Object.assign(player, s.player);
                    if (Array.isArray(s.claimed)) player.claimed = new Set(s.claimed);
                    if (Array.isArray(s.playerLatLng)) playerLatLng = L.latLng(s.playerLatLng[0], s.playerLatLng[1]);
                }
            } catch (e) { }
        } loadState();

        function setStatus(t, ms = 2500) {
            const el = document.getElementById('status'); el.textContent = `Status: ${t}`;
            clearTimeout(el._t); el._t = setTimeout(() => el.textContent = wallet ? 'Status: connected' : 'Status: ready', ms);
        }
        function updateUI() {
            document.getElementById('lvl').textContent = player.lvl;
            document.getElementById('hp').textContent = `${player.hp}/${player.maxHp}`;
            document.getElementById('caps').textContent = player.caps;
            document.getElementById('claimed').textContent = player.claimed.size;
        }

        // PHANTOM + SERVER SYNC
        document.getElementById('connectPhantom').addEventListener('click', async () => {
            if (wallet) { setStatus('Refreshing...'); await syncPlayerFromServer(); return; }
            try {
                const p = window.solana;
                if (!p?.isPhantom) return alert('Install Phantom: https://phantom.app');
                await p.connect(); wallet = p;
                const addr = p.publicKey.toBase58();
                document.getElementById('connectPhantom').textContent = `${addr.slice(0, 4)}...${addr.slice(-4)}`;
                await syncPlayerFromServer();
            } catch (e) { setStatus('Canceled'); }
        });

        async function syncPlayerFromServer() {
            if (!wallet) return;
            try {
                const res = await fetch(`/player/${wallet.publicKey.toBase58()}`);
                if (!res.ok) throw 0;
                const d = await res.json();
                Object.assign(player, d); player.claimed = new Set(d.claimed || []);
                updateUI(); saveState();
                setStatus(`Synced – Lvl ${player.lvl} | ${player.caps} CAPS`);
            } catch (e) { setStatus('Server offline – local save active'); }
        }
        function afterSuccessfulClaim() { saveState(); updateUI(); syncPlayerFromServer(); }

        // TABS + DRAWER — FULLY WORKING
        const tabs = document.querySelectorAll('.tab');
        const drawer = document.getElementById('sidePanel');
        const panelTitle = document.getElementById('panelTitle');
        const panelBody = document.getElementById('panelBody');

        tabs.forEach(tab => tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const p = tab.dataset.panel;
            if (p === 'map') { drawer.classList.remove('open'); return; }
            drawer.classList.add('open');
            panelTitle.textContent = p.toUpperCase();
            if (p === 'stat') renderStats();
            if (p === 'items') renderItems();
            if (p === 'quests') renderQuests();
        }));
        document.getElementById('panelClose').onclick = () => {
            drawer.classList.remove('open');
            document.querySelector('.tab[data-panel="map"]').classList.add('active');
        };

        function renderStats() {
            panelBody.innerHTML = `
        <div class="list-item"><div><strong>LEVEL</strong></div><div class="muted">${player.lvl}</div></div>
        <div class="list-item"><div><strong>HP</strong></div><div class="muted">${player.hp}/${player.maxHp}</div></div>
        <div class="list-item"><div><strong>CAPS</strong></div><div class="muted">${player.caps}</div></div>
        <div class="list-item"><div><strong>CLAIMED</strong></div><div class="muted">${player.claimed.size}</div></div>
      `;
        }
        function renderItems() {
            if (!player.gear?.length) {
                panelBody.innerHTML = `<div class="list-item"><strong>No gear yet</strong><div class="muted">Claim POIs to loot</div></div>`;
                return;
            }
            panelBody.innerHTML = player.gear.map(g =>
                `<div class="list-item"><div><strong>${g.name || 'Unknown Item'}</strong><div class="muted">${g.rarity || 'common'}</div></div><div class="muted">x${g.qty || 1}</div></div>`
            ).join('');
        }
        function renderQuests() {
            panelBody.innerHTML = `
        <div class="list-item"><div><strong>Find Vault 77 Key</strong><div class="muted-small">Legend says it's hidden in the Mojave...</div></div><div class="muted">ACTIVE</div></div>
        <div class="list-item"><div><strong>Repair Helios One</strong><div class="muted-small">Collect 3 solar cells from the wasteland</div></div><div class="muted">AVAILABLE</div></div>
      `;
        }

        // MAP + CLAIM
        async function loadAndInitMap() {
            map = L.map('map').setView([36.1146, -115.1728], 12);
            L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 20 }).addTo(map);
            try {
                const res = await fetch(`${API_BASE}/locations`);
                const locs = await res.json();
                locs.forEach(loc => {
                    const color = loc.rarity === 'legendary' ? '#ffff00' : loc.rarity === 'epic' ? '#ff6200' : loc.rarity === 'rare' ? '#00ffff' : '#00ff41';
                    const m = L.circleMarker([loc.lat, loc.lng], { radius: 14, color: '#001100', weight: 4, fillColor: color, fillOpacity: 0.95 })
                        .bindPopup(`<b style="color:#0ff">${loc.n}</b><br><span style="padding:4px 8px;border-radius:12px;background:${color};color:#000">${(loc.rarity || 'common').toUpperCase()}</span><br>Level ${loc.lvl || 1}`)
                        .on('click', () => attemptClaim(loc)).addTo(map);
                    markers[loc.n] = m;
                    if (player.claimed.has(loc.n)) m.setStyle({ fillColor: '#001a00', fillOpacity: 0.6 });
                });
            } catch (e) { setStatus('POI load failed'); }
            if (playerLatLng) { playerMarker = L.circleMarker([playerLatLng.lat, playerLatLng.lng], { radius: 8, color: '#00ff41', weight: 3, fillColor: '#00ff41', fillOpacity: 1 }).addTo(map).bindPopup('You'); map.panTo(playerLatLng); }
        }
        loadAndInitMap();

        async function claimLoot(loc) {
            if (!wallet) return alert('Connect wallet!');
            if (player.claimed.has(loc.n)) return alert('Already looted!');
            if (lastAccuracy > MAX_ACCEPTABLE_ACCURACY) return alert(`GPS too weak (${Math.round(lastAccuracy)}m)`);
            if (!playerLatLng) return alert('Wait for GPS lock');
            const dist = map.distance(playerLatLng, L.latLng(loc.lat, loc.lng));
            if (dist > CLAIM_RADIUS_METERS) return alert(`Too far (${Math.round(dist)}m)`);

            let sig = null;
            try {
                const msg = `AtomicFizz claim:${loc.n}:${Date.now()}`;
                const enc = new TextEncoder().encode(msg);
                const signed = await wallet.signMessage(enc, 'utf8');
                sig = btoa(String.fromCharCode(...signed.signature));
            } catch (e) { return alert('Signature canceled'); }

            openMintModal(`Claiming ${loc.n}...`);
            try {
                const r = await fetch(`${API_BASE}/claim-survival`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet: wallet.publicKey.toBase58(), spot: loc.n, lat: playerLatLng.lat, lng: playerLatLng.lng, signature: sig })
                });
                const d = await r.json();
                if (!r.ok || !d.success) return openMintModal(`Failed: ${d.error || 'server error'}`, true);
                player.caps += (d.capsEarned || 25);
                if (d.loot) player.gear.push(d.loot);
                player.claimed.add(loc.n);
                if (markers[loc.n]) markers[loc.n].setStyle({ fillColor: '#001a00', fillOpacity: 0.6 });
                afterSuccessfulClaim();
                openMintModal(`LOOTED! +${d.capsEarned || 25} CAPS`, false, d);
                setStatus(`${loc.n} claimed!`, 4000);
            } catch (e) { openMintModal('Claim failed', true); }
        }
        async function attemptClaim(loc) {
            if (lastAccuracy > MAX_ACCEPTABLE_ACCURACY) return setStatus(`GPS too weak (${Math.round(lastAccuracy)}m)`, 3000);
            const dist = map.distance(playerLatLng, L.latLng(loc.lat, loc.lng));
            if (dist > CLAIM_RADIUS_METERS) return setStatus(`Too far (${Math.round(dist)}m)`, 3000);
            await claimLoot(loc);
        }

        function openMintModal(msg, isError = false, data = null) {
            const m = document.getElementById('mintModal'), t = document.getElementById('mintTitle'),
                msgEl = document.getElementById('mintMsg'), bar = document.getElementById('mintProgress').firstElementChild;
            t.textContent = isError ? 'Mint Error' : 'Minting NFT';
            msgEl.innerHTML = msg + (data?.chainTx ? `<br><a href="${data.chainTx.explorer || ''}" target="_blank" style="color:#66ff99">View TX</a>` : '');
            bar.style.width = isError ? '0%' : '80%'; m.classList.add('open');
        }
        document.getElementById('mintCloseBtn').onclick = () => document.getElementById('mintModal').classList.remove('open');

        navigator.geolocation?.watchPosition(p => { const { latitude: lat, longitude: lng, accuracy } = p.coords; pushGpsSample(lat, lng, accuracy); }, null, { enableHighAccuracy: true });
        document.getElementById('centerBtn').onclick = () => playerLatLng && map.flyTo([playerLatLng.lat, playerLatLng.lng], 16, { duration: 0.6 });
        document.getElementById('recenterMojave').onclick = () => map.flyTo([36.17, -115.14], 8, { duration: 0.6 });
        setInterval(saveState, 5000); updateUI();
    </script>
</body>
</html>