<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>ATOMIC FIZZ • VAULT 77 • WASTELAND GPS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- Vercel Speed Insights - CDN script for monitoring performance metrics -->
    <script defer src="https://cdn.vercel-insights.com/v1/script.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0 }
        html, body { height: 100%; background: #000; font-family: VT323,monospace; color: #00ff41 }
        body { background: radial-gradient(circle at center,#002200,#000) }
        .pipboy { position: fixed; inset: 0; padding: 12px; background: #001100; box-shadow: 0 0 160px #00ff41 }
        .panel { position: absolute; inset: 12px; background: #000; border-radius: 14px; padding: 14px; overflow: hidden; box-shadow: inset 0 0 80px #003300,0 0 80px rgba(0,255,65,0.18) }
        h1 { font-size: 2.6rem; letter-spacing: 8px; background: linear-gradient(90deg,#00ff41,#66ff99); -webkit-background-clip: text; color: transparent; margin-bottom: 6px }
        .sub { opacity: 0.6; letter-spacing: 6px; margin-bottom: 12px }
        .header-row { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap }
        .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap }
        .btn, .wallet-btn { background: #001100; color: #00ff41; border: 2px solid #00ff41; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold }
        .wallet-btn { background: #002200 }
        #status { color: #ff66aa; font-size: 0.95rem; min-width: 220px; text-align: right }
        .statbar { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin: 12px 0 }
        .stat { background: #000; border-radius: 8px; padding: 10px; border: 2px solid rgba(0,255,65,0.06); text-align: center }
        .val { font-size: 1.6rem; color: #ffff66 }
        #mapWrap { height: 56vh; border-radius: 10px; overflow: hidden; border: 2px solid rgba(0,255,65,0.06); position: relative }
        #map { width: 100%; height: 100% }
        .tabs { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap }
        .tab { padding: 8px 12px; border-radius: 8px; background: rgba(0,0,0,0.25); border: 1px solid rgba(0,255,65,0.06); cursor: pointer }
        .tab.active { background: #002200; border-color: #00ff41 }
        .drawer { position: absolute; right: 18px; top: 86px; width: 360px; max-height: 56%; background: rgba(0,17,0,0.96); border: 2px solid #00ff41; border-radius: 10px; padding: 12px; overflow-y: auto; z-index: 1400; display: none }
        .drawer.open { display: block }
        .list-item { padding: 8px 10px; border-bottom: 1px dashed rgba(0,255,65,0.06); display: flex; justify-content: space-between; align-items: center }
        .muted { opacity: 0.7 }
        .muted-small { font-size: 0.85rem; opacity: 0.8 }
        .gps-badge { position: absolute; left: 18px; bottom: 18px; background: rgba(0,0,0,0.8); border: 2px solid #00ff41; padding: 8px 12px; border-radius: 10px; display: flex; gap: 8px; align-items: center; z-index: 1200 }
        .acc-dot { width: 12px; height: 12px; border-radius: 50%; background: #ff6666; box-shadow: 0 0 8px rgba(255,102,102,0.2) }
        .acc-green { background: #66ff99; box-shadow: 0 0 8px rgba(102,255,153,0.12) }
        .shop-listing { background: rgba(0,30,0,0.5); padding: 10px; margin: 8px 0; border: 1px dashed #00ff41; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px }
        .buy-btn { background: #002200; border: 1px solid #00ff41; padding: 6px 10px; cursor: pointer; border-radius: 6px }
        .sol-btn { background: #ff4400; color: #000; font-weight: bold; }
        @media (max-width:640px) { .drawer { width: 100%; right: 0; left: 0; top: auto; bottom: 0; border-radius: 14px 14px 0 0 } .statbar { grid-template-columns: repeat(2,1fr) } }
    </style>
</head>
<body>
    <div class="pipboy">
        <div class="panel">
            <div class="header-row">
                <div><h1>ATOMIC FIZZ</h1><div class="sub">VAULT 77 • WASTELAND GPS</div></div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
                    <div class="controls">
                        <button class="btn" id="centerBtn">Center on Player</button>
                        <button class="btn" id="recenterMojave">Recenter Mojave</button>
                        <button class="wallet-btn" id="connectPhantom">Connect Phantom</button>
                    </div>
                    <div id="status">Status: ready</div>
                </div>
            </div>
            <div class="statbar">
                <div class="stat"><div class="val" id="lvl">1</div><div class="muted-small">LEVEL</div></div>
                <div class="stat"><div class="val" id="hp">100/100</div><div class="muted-small">HP</div></div>
                <div class="stat"><div class="val" id="caps">0</div><div class="muted-small">CAPS</div></div>
                <div class="stat"><div class="val" id="claimed">0</div><div class="muted-small">CLAIMED</div></div>
            </div>
            <div id="mapWrap">
                <div id="map"></div>
                <div class="gps-badge"><div id="accDot" class="acc-dot"></div><div id="accText">GPS: —</div></div>
            </div>
            <div class="tabs">
                <div class="tab active" data-panel="map">MAP</div>
                <div class="tab" data-panel="stat">STAT</div>
                <div class="tab" data-panel="items">ITEMS</div>
                <div class="tab" data-panel="quests">QUESTS</div>
                <div class="tab" data-panel="shop">SCAVENGER'S EXCHANGE</div>
            </div>
            <div class="drawer" id="sidePanel">
                <button class="btn" id="panelClose" style="float:right">X</button>
                <h4 id="panelTitle">Panel</h4>
                <div id="panelBody"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/bs58@6.0.0/dist/index.min.js"></script>
    <script>
        const API_BASE = window.location.origin;
        let map, playerMarker = null, wallet = null, playerLatLng = null, lastAccuracy = 999;
        let player = { lvl: 1, hp: 100, caps: 0, found: [], claimed: new Set() };
        let locations = [], markers = {};

        const CLAIM_RADIUS = 50;
        const SOL_RECIPIENT = "REPLACE_WITH_YOUR_VAULT_OR_DEV_WALLET";

        function setStatus(text, time = 3000) {
            const s = document.getElementById('status');
            s.textContent = `Status: ${text}`;
            clearTimeout(s.to);
            s.to = setTimeout(() => s.textContent = wallet ? 'Status: connected' : 'Status: ready', time);
        }

        function updateUI() {
            document.getElementById('lvl').textContent = player.lvl || 1;
            document.getElementById('hp').textContent = `${player.hp || 100}/100`;
            document.getElementById('caps').textContent = player.caps || 0;
            document.getElementById('claimed').textContent = player.claimed.size;
        }

        document.getElementById('connectPhantom').onclick = async () => {
            if (wallet) { setStatus('Syncing...'); await syncPlayer(); return; }
            try {
                const p = window.solana;
                if (!p?.isPhantom) return alert('Install Phantom wallet');
                await p.connect();
                wallet = p;
                const addr = p.publicKey.toBase58();
                document.getElementById('connectPhantom').textContent = `${addr.slice(0,4)}...${addr.slice(-4)}`;
                await syncPlayer();
            } catch { setStatus('Canceled'); }
        };

        async function syncPlayer() {
            if (!wallet) return;
            try {
                const res = await fetch(`${API_BASE}/player/${wallet.publicKey.toBase58()}`);
                if (res.ok) {
                    const d = await res.json();
                    player = { ...player, ...d };
                    player.claimed = new Set(d.found || []);
                    updateUI();
                    markClaimed();
                }
            } catch { }
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            const p = t.dataset.panel;
            const drawer = document.getElementById('sidePanel');
            if (p === 'map') return drawer.classList.remove('open');
            drawer.classList.add('open');
            document.getElementById('panelTitle').textContent = t.textContent;
            if (p === 'stat') renderStats();
            if (p === 'quests') renderQuests();
            if (p === 'shop') renderShop();
        });
        document.getElementById('panelClose').onclick = () => {
            document.getElementById('sidePanel').classList.remove('open');
            document.querySelector('.tab[data-panel="map"]').classList.add('active');
        };

        function renderStats() {
            document.getElementById('panelBody').innerHTML = `
                <div class="list-item"><strong>LEVEL</strong><div>${player.lvl || 1}</div></div>
                <div class="list-item"><strong>HP</strong><div>${player.hp || 100}/100</div></div>
                <div class="list-item"><strong>CAPS</strong><div>${player.caps || 0}</div></div>
                <div class="list-item"><strong>CLAIMED</strong><div>${player.claimed.size}</div></div>
            `;
        }

        async function renderQuests() {
            document.getElementById('panelBody').innerHTML = '<div class="list-item">Loading...</div>';
            try {
                const res = await fetch(`${API_BASE}/quests`);
                const q = await res.json();
                document.getElementById('panelBody').innerHTML = q.map(x => `<div class="list-item"><strong>${x.title}</strong><div class="muted-small">${x.desc}</div></div>`).join('') || '<div class="list-item">No quests</div>';
            } catch {
                document.getElementById('panelBody').innerHTML = '<div class="list-item">Offline</div>';
            }
        }

        async function renderShop() {
            document.getElementById('panelBody').innerHTML = '<div class="list-item">Loading...</div>';
            try {
                const res = await fetch(`${API_BASE}/shop/listings`);
                const list = await res.json();
                document.getElementById('panelBody').innerHTML = list.map(l => `
                    <div class="shop-listing">
                        <div><strong>NFT ${l.nft.slice(0,8)}...</strong><br><span class="muted">${l.price} CAPS</span></div>
                        <div>
                            <button class="buy-btn" onclick="buyCaps('${l.nft}',${l.price})">CAPS</button>
                            <button class="buy-btn sol-btn" onclick="solPay('${l.nft}',${l.price})">SOL</button>
                        </div>
                        <div id="qr-${l.nft}"></div>
                    </div>
                `).join('') || '<div class="list-item">Shop empty</div>';
            } catch {
                document.getElementById('panelBody').innerHTML = '<div class="list-item">Offline</div>';
            }
        }

        window.buyCaps = async (nft, price) => {
            if (!wallet) return alert('Connect wallet');
            const msg = `Buy ${nft} for ${price} CAPS ${Date.now()}`;
            try {
                const enc = new TextEncoder().encode(msg);
                const sig = await wallet.signMessage(enc);
                const res = await fetch(`${API_BASE}/shop/buy`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({wallet: wallet.publicKey.toBase58(), nftAddress: nft, message: msg, signature: bs58.encode(sig)}) });
                const d = await res.json();
                alert(d.success ? 'Purchased!' : d.error);
                if (d.success) { player.caps -= price; updateUI(); renderShop(); }
            } catch { alert('Canceled'); }
        };

        window.solPay = (nft, price) => {
            const amt = (price / 10000).toFixed(6);
            const url = `solana:${SOL_RECIPIENT}?amount=${amt}&label=AtomicFizz&reference=${nft}`;
            const c = document.getElementById(`qr-${nft}`);
            c.innerHTML = '<canvas id="qrc"></canvas><div class="muted">Scan to pay</div>';
            QRCode.toCanvas(document.getElementById('qrc'), url, {width:180});
        };

        // Map
        async function initMap() {
            map = L.map('map').setView([36.1146, -115.1728], 11);
            L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {subdomains:['mt0','mt1','mt2','mt3'], maxZoom:20}).addTo(map);

            const res = await fetch(`${API_BASE}/locations`);
            locations = await res.json();
            locations.forEach(loc => {
                const m = L.circleMarker([loc.lat, loc.lng], {radius:16, weight:4, color:'#001100', fillColor:'#00ff41', fillOpacity:0.9})
                    .addTo(map)
                    .bindPopup(`<b>${loc.n}</b><br>Level ${loc.lvl||1}`)
                    .on('click', () => claim(loc));
                markers[loc.n] = m;
            });
            markClaimed();
        }

        function markClaimed() {
            Object.keys(markers).forEach(n => {
                if (player.claimed.has(n)) markers[n].setStyle({fillColor:'#003300', fillOpacity:0.5});
            });
        }

        async function claim(loc) {
            if (lastAccuracy > 20) return setStatus('GPS too weak');
            if (!playerLatLng) return setStatus('No GPS');
            const dist = map.distance(playerLatLng, [loc.lat, loc.lng]);
            if (dist > CLAIM_RADIUS) return setStatus(`Too far (${Math.round(dist)}m)`);

            if (!wallet) return alert('Connect wallet');
            if (player.claimed.has(loc.n)) return setStatus('Already claimed');

            const msg = `Claim ${loc.n} ${Date.now()}`;
            try {
                const enc = new TextEncoder().encode(msg);
                const sig = await wallet.signMessage(enc);
                const res = await fetch(`${API_BASE}/find-loot`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
                    wallet: wallet.publicKey.toBase58(),
                    spot: loc.n,
                    lat: playerLatLng.lat,
                    lng: playerLatLng.lng,
                    message: msg,
                    signature: bs58.encode(sig)
                })});
                const d = await res.json();
                if (d.success) {
                    player.caps = d.totalCaps;
                    player.claimed.add(loc.n);
                    markers[loc.n].setStyle({fillColor:'#003300', fillOpacity:0.5});
                    updateUI();
                    setStatus(`+${d.capsFound} CAPS!`);
                } else setStatus(d.error);
            } catch { setStatus('Canceled'); }
        }

        navigator.geolocation?.watchPosition(p => {
            lastAccuracy = p.coords.accuracy;
            document.getElementById('accText').textContent = `GPS: ${Math.round(lastAccuracy)}m`;
            document.getElementById('accDot').className = lastAccuracy <= 20 ? 'acc-dot acc-green' : 'acc-dot';
            playerLatLng = L.latLng(p.coords.latitude, p.coords.longitude);
            if (!playerMarker) playerMarker = L.circleMarker(playerLatLng, {radius:10, color:'#00ff41', fillOpacity:0.9}).addTo(map);
            playerMarker.setLatLng(playerLatLng);
        }, null, {enableHighAccuracy:true});

        document.getElementById('centerBtn').onclick = () => playerLatLng && map.flyTo(playerLatLng, 17);
        document.getElementById('recenterMojave').onclick = () => map.setView([36.17, -115.14], 10);

        initMap();
        updateUI();
    </script>

    <!-- Initialize Speed Insights monitoring (client-side only) -->
    <script src="/speed-insights.js"></script>
</body>
</html>